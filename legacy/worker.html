<!DOCTYPE html>
<html lang="ko" prefix="og: http://ogp.me/ns#">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8" />
  <title>작업자 페이지 | 원스톱 벌초</title>
  <meta name="description" content="원스톱 벌초 서비스 작업자 페이지입니다. 배정된 작업 내역과 작업 로그를 확인할 수 있습니다." />
  <meta name="keywords" content="작업자, 원스톱 벌초, 작업 관리, 대시보드" />

  <!-- Open Graph Meta Tags -->
  <meta property="og:title" content="작업자 페이지 | 원스톱 벌초">
  <meta property="og:description" content="원스톱 벌초 서비스 작업자 페이지입니다. 배정된 작업 내역과 작업 로그를 확인할 수 있습니다.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://onestopbeolcho.com/worker/worker.html">
  <meta property="og:image" content="https://onestopbeolcho.com/assets/images/main.png">
  <meta property="og:image:alt" content="원스톱벌초 서비스 메인 이미지">

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1E88E5" />
  <link rel="apple-touch-icon" sizes="192x192" href="/assets/icons/icon-192x192.png" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="styles/common.css">
  
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ef6b942fdad36e982c84eb0061d1d2ed"></script>

  <!-- 외부 스크립트 -->
  <script src="scripts/nav.js" type="module" defer></script>
  <script src="scripts/footer.js" type="module" defer></script>
  <script src="scripts/common.js" defer></script>
  <script src="scripts/worker.js" type="module" defer></script>

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f6f9;
    }
    .sidebar {
      min-height: 100vh;
      background-color: #1E88E5;
      color: white;
      position: fixed;
      width: 250px;
      top: 0;
      left: 0;
      z-index: 1000;
      transition: all 0.3s;
    }
    .sidebar .nav-link {
      color: white;
      padding: 10px 20px;
      font-size: 1rem;
      transition: background-color 0.3s;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active {
      background-color: #1565C0;
    }
    .sidebar .nav-link i {
      margin-right: 10px;
    }
    .main-content {
      margin-left: 250px;
      padding: 20px;
      transition: all 0.3s;
    }
    .dashboard-card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      background-color: white;
      padding: 20px;
      margin-bottom: 20px;
    }
    .table-responsive {
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 15px;
    }
    .feedback-message {
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 10px;
      text-align: center;
      font-size: 0.9rem;
      display: none;
    }
    .feedback-message.error {
      background: #ffebee;
      color: #c62828;
      display: block;
    }
    .feedback-message.success {
      background: #e3f2fd;
      color: #1E88E5;
      display: block;
    }
    .photo-gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .photo-gallery img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 5px;
    }
    .photo-gallery .photo-container {
      position: relative;
    }
    .photo-gallery .delete-photo-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 200px;
        left: -200px;
      }
      .sidebar.active {
        left: 0;
      }
      .main-content {
        margin-left: 0;
      }
      .main-content.active {
        margin-left: 200px;
      }
    }
  </style>
</head>
<body>
  <!-- 사이드바 -->
  <nav class="sidebar" id="sidebar">
    <div class="p-4">
      <h4 class="text-white mb-4">작업자 페이지</h4>
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link active" href="#" data-bs-toggle="tab" data-bs-target="#dashboard"><i class="fas fa-tachometer-alt"></i> 대시보드</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-bs-toggle="tab" data-bs-target="#request"><i class="fas fa-list"></i> 배정 가능한 작업</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" data-bs-toggle="tab" data-bs-target="#work-logs"><i class="fas fa-tasks"></i> 작업 로그</a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- 메인 콘텐츠 -->
  <div class="main-content" id="main-content">
    <div class="feedback-message" id="feedback-message"></div>
    <div class="d-flex justify-content-between align-items-center mb-3">
      <button class="btn btn-primary d-md-none" id="sidebarToggle"><i class="fas fa-bars"></i></button>
      <button class="btn btn-outline-primary" id="goToUserPage"><i class="fas fa-external-link-alt"></i> 사용자 페이지로 이동</button>
    </div>
    <div class="tab-content">
      <!-- 대시보드 탭 -->
      <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
        <h3 class="mb-4">대시보드</h3>
        <div class="row">
          <div class="col-md-4 col-sm-6 mb-3">
            <div class="dashboard-card text-center">
              <i class="fas fa-list-alt mb-2"></i>
              <h5>총 배정 가능한 작업</h5>
              <p id="total-requests-worker">0</p>
            </div>
          </div>
          <div class="col-md-4 col-sm-6 mb-3">
            <div class="dashboard-card text-center">
              <i class="fas fa-tasks mb-2"></i>
              <h5>진행 중인 작업</h5>
              <p id="ongoing-works-worker">0</p>
            </div>
          </div>
          <div class="col-md-4 col-sm-6 mb-3">
            <div class="dashboard-card text-center">
              <i class="fas fa-check-circle mb-2"></i>
              <h5>완료된 작업</h5>
              <p id="completed-works-worker">0</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 배정 가능한 작업 탭 -->
      <div class="tab-pane fade" id="request" role="tabpanel">
        <h3 class="mb-4">배정 가능한 작업</h3>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>신청 ID</th>
                <th>고객 이름</th>
                <th>연락처</th>
                <th>주소</th>
                <th>지역</th>
                <th>서비스 유형</th>
                <th>상태</th>
                <th>작업 날짜</th>
                <th>작업</th>
              </tr>
            </thead>
            <tbody id="request-table"></tbody>
          </table>
        </div>
      </div>

      <!-- 작업 로그 탭 -->
      <div class="tab-pane fade" id="work-logs" role="tabpanel">
        <h3 class="mb-4">작업 로그</h3>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>신청 ID</th>
                <th>서비스 유형</th>
                <th>고객 이름</th>
                <th>상태</th>
                <th>작업 시작 시간</th>
                <th>작업 종료 시간</th>
                <th>업데이트 날짜</th>
                <th>메모</th>
                <th>작업</th>
              </tr>
            </thead>
            <tbody id="work-logs-table"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- 지도 보기 모달 -->
  <div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="mapModalLabel">위치 보기</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="map" style="height: 400px; width: 100%;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 사진 업로드 모달 -->
  <div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="photoModalLabel">작업 사진 관리</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <h6>작업 전 사진</h6>
          <input type="file" id="beforeWorkPhotos" multiple accept="image/*">
          <div id="beforeWorkPhotosGallery" class="photo-gallery"></div>
          <h6>작업 후 사진</h6>
          <input type="file" id="afterWorkPhotos" multiple accept="image/*">
          <div id="afterWorkPhotosGallery" class="photo-gallery"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button type="button" class="btn btn-primary" id="savePhotos">저장</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 최종 견적 모달 -->
  <div class="modal fade" id="finalCostModal" tabindex="-1" aria-labelledby="finalCostModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="finalCostModalLabel">최종 견적 제출</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="finalCostInput">최종 견적 (원)</label>
          <input type="number" id="finalCostInput" class="form-control" required>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button type="button" class="btn btn-primary" id="submitFinalCost">제출</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 메시지 모달 -->
  <div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="messageModalLabel">고객에게 메시지 보내기</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label for="messageInput">메시지</label>
          <textarea id="messageInput" class="form-control" rows="3" required></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
          <button type="button" class="btn btn-primary" id="sendMessage">보내기</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
  <script type="module">
    import { auth, db } from '/scripts/firebase-config.js';
    import { setPersistence, browserLocalPersistence, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js';
    import { collection, query, where, orderBy, updateDoc, doc, onSnapshot, serverTimestamp, getDocs, getDoc, addDoc } from 'https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore.js';
    import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/11.5.0/firebase-storage.js';

    let currentMap;
    let currentRequestId;

    document.addEventListener('DOMContentLoaded', () => {
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('main-content');
      const sidebarToggle = document.getElementById('sidebarToggle');
      sidebarToggle.addEventListener('click', () => {
        sidebar.classList.toggle('active');
        mainContent.classList.toggle('active');
      });

      document.getElementById('goToUserPage').addEventListener('click', () => {
        window.open('/index.html', '_blank');
      });

      setPersistence(auth, browserLocalPersistence)
        .then(() => console.log('세션 영속성 설정 완료'))
        .catch(error => console.error('세션 영속성 설정 오류:', error));

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.replace('/login.html');
          return;
        }

        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().isWorker) {
          const workerRegions = userDoc.data().regions || [];
          const workerId = user.uid;
          if (workerRegions.length === 0) {
            document.getElementById('feedback-message').textContent = '작업자의 지역 정보가 없습니다.';
            document.getElementById('feedback-message').classList.add('error');
            return;
          }
          loadWorkerDashboard(workerRegions);
          const tabs = document.querySelectorAll('.nav-link');
          tabs.forEach(tab => {
            tab.addEventListener('click', () => {
              const target = tab.getAttribute('data-bs-target');
              if (target === '#dashboard') loadWorkerDashboard(workerRegions);
              else if (target === '#request') loadWorkerRequests(workerRegions, workerId);
              else if (target === '#work-logs') loadWorkerLogs(workerId);
            });
          });
        } else {
          window.location.replace('/login.html');
        }
      });

      async function loadWorkerDashboard(workerRegions) {
        const requestsSnapshot = await getDocs(collection(db, 'serviceRequests'));
        let totalRequests = 0;
        let ongoingRequests = 0;
        let completedRequests = 0;

        requestsSnapshot.forEach(doc => {
          const request = doc.data();
          const region = request.region || '';
          if (workerRegions.some(workerRegion => region.includes(workerRegion))) {
            totalRequests++;
            if (request.status === 'confirmed' && request.workerId) {
              ongoingRequests++;
            }
            if (request.status === 'completed' && request.workerId) {
              completedRequests++;
            }
          }
        });

        document.getElementById('total-requests-worker').textContent = totalRequests;
        document.getElementById('ongoing-works-worker').textContent = ongoingRequests;
        document.getElementById('completed-works-worker').textContent = completedRequests;
      }

      function loadWorkerRequests(workerRegions, workerId) {
        const requestTable = document.getElementById('request-table');
        requestTable.innerHTML = '';
        const q = query(collection(db, 'serviceRequests'), orderBy('createdAt', 'desc'));
        onSnapshot(q, (snapshot) => {
          requestTable.innerHTML = '';
          snapshot.forEach((doc) => {
            const request = doc.data();
            const region = request.region || '';
            if (workerRegions.some(workerRegion => region.includes(workerRegion))) {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${doc.id}</td>
                <td>${request.customerName || '미등록'}</td>
                <td>${request.customerPhone || '미등록'}</td>
                <td>${request.address || '-'}</td>
                <td>${region || '-'}</td>
                <td>${request.serviceType || '-'}</td>
                <td>${request.status || 'pending'}</td>
                <td>${request.workDate || '-'}</td>
                <td>
                  ${request.status === 'pending' && !request.workerId ? `
                    <button class="btn btn-success btn-sm accept-request" data-id="${doc.id}">수락</button>
                    <button class="btn btn-danger btn-sm reject-request" data-id="${doc.id}">거부</button>
                  ` : request.status === 'confirmed' && request.workerId === workerId ? `
                    <button class="btn btn-primary btn-sm update-status" data-id="${doc.id}" data-status="in-progress">작업 시작</button>
                    <button class="btn btn-danger btn-sm reject-request" data-id="${doc.id}">거부</button>
                  ` : request.status === 'in-progress' && request.workerId === workerId ? `
                    <button class="btn btn-success btn-sm update-status" data-id="${doc.id}" data-status="completed">작업 완료</button>
                    <button class="btn btn-danger btn-sm reject-request" data-id="${doc.id}">거부</button>
                  ` : request.status === 'completed' && request.workerId === workerId ? `
                    <span>완료됨</span>
                  ` : request.workerId && request.workerId !== workerId ? `
                    <span>다른 작업자가 수락함</span>
                  ` : ''}
                  <button class="btn btn-info btn-sm show-map" data-lat="${request.latitude}" data-lng="${request.longitude}" data-address="${request.address || ''}" data-customer="${request.customerName || '미등록'}">지도 보기</button>
                  ${request.workerId === workerId ? `
                    <button class="btn btn-warning btn-sm manage-photos" data-id="${doc.id}">사진 관리</button>
                    <button class="btn btn-primary btn-sm submit-final-cost" data-id="${doc.id}">최종 견적 제출</button>
                    <button class="btn btn-secondary btn-sm send-message" data-id="${doc.id}" data-customer-id="${request.customerId}">메시지 보내기</button>
                  ` : ''}
                </td>
              `;
              requestTable.appendChild(row);
            }
          });

          document.querySelectorAll('.accept-request').forEach(button => {
            button.addEventListener('click', async () => {
              const id = button.getAttribute('data-id');
              try {
                console.log('workerId:', workerId, 'user.uid:', auth.currentUser.uid);
                await updateDoc(doc(db, 'serviceRequests', id), {
                  workerId: workerId,
                  status: 'confirmed'
                });
                const requestDoc = await getDoc(doc(db, 'serviceRequests', id));
                const requestData = requestDoc.exists() ? requestDoc.data() : {};
                await addDoc(collection(db, 'workLogs'), {
                  requestId: id,
                  workerId: workerId,
                  status: 'confirmed',
                  updatedAt: serverTimestamp(),
                  requestDetails: {
                    serviceType: requestData.serviceType || '알 수 없음',
                    customerName: requestData.customerName || '알 수 없음',
                    region: requestData.region || '알 수 없음'
                  }
                });
                document.getElementById('feedback-message').textContent = '작업이 수락되었습니다.';
                document.getElementById('feedback-message').classList.add('success');
                setTimeout(() => document.getElementById('feedback-message').classList.remove('success'), 2000);
              } catch (error) {
                console.error('수락 오류:', error);
                document.getElementById('feedback-message').textContent = '수락 실패: ' + error.message;
                document.getElementById('feedback-message').classList.add('error');
                setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
              }
            });
          });

          document.querySelectorAll('.reject-request').forEach(button => {
            button.addEventListener('click', async () => {
              const id = button.getAttribute('data-id');
              try {
                console.log('workerId:', workerId, 'user.uid:', auth.currentUser.uid);
                await updateDoc(doc(db, 'serviceRequests', id), {
                  workerId: null,
                  status: 'pending'
                });
                const requestDoc = await getDoc(doc(db, 'serviceRequests', id));
                const requestData = requestDoc.exists() ? requestDoc.data() : {};
                await addDoc(collection(db, 'workLogs'), {
                  requestId: id,
                  workerId: workerId,
                  status: 'rejected',
                  updatedAt: serverTimestamp(),
                  requestDetails: {
                    serviceType: requestData.serviceType || '알 수 없음',
                    customerName: requestData.customerName || '알 수 없음',
                    region: requestData.region || '알 수 없음'
                  }
                });
                document.getElementById('feedback-message').textContent = '작업이 거부되었습니다.';
                document.getElementById('feedback-message').classList.add('success');
                setTimeout(() => document.getElementById('feedback-message').classList.remove('success'), 2000);
              } catch (error) {
                console.error('거부 오류:', error);
                document.getElementById('feedback-message').textContent = '거부 실패: ' + error.message;
                document.getElementById('feedback-message').classList.add('error');
                setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
              }
            });
          });

          document.querySelectorAll('.update-status').forEach(button => {
            button.addEventListener('click', async () => {
              const id = button.getAttribute('data-id');
              const status = button.getAttribute('data-status');
              try {
                console.log('workerId:', workerId, 'user.uid:', auth.currentUser.uid);
                await updateDoc(doc(db, 'serviceRequests', id), { status: status });
                const requestDoc = await getDoc(doc(db, 'serviceRequests', id));
                const requestData = requestDoc.exists() ? requestDoc.data() : {};
                await addDoc(collection(db, 'workLogs'), {
                  requestId: id,
                  workerId: workerId,
                  status: status,
                  updatedAt: serverTimestamp(),
                  ...(status === 'in-progress' && { startTime: serverTimestamp() }),
                  ...(status === 'completed' && { endTime: serverTimestamp() }),
                  requestDetails: {
                    serviceType: requestData.serviceType || '알 수 없음',
                    customerName: requestData.customerName || '알 수 없음',
                    region: requestData.region || '알 수 없음'
                  }
                });
                document.getElementById('feedback-message').textContent = `작업 상태가 '${status}'로 업데이트되었습니다.`;
                document.getElementById('feedback-message').classList.add('success');
                setTimeout(() => document.getElementById('feedback-message').classList.remove('success'), 2000);
              } catch (error) {
                console.error('상태 업데이트 오류:', error);
                document.getElementById('feedback-message').textContent = '상태 업데이트 실패: ' + error.message;
                document.getElementById('feedback-message').classList.add('error');
                setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
              }
            });
          });

          document.querySelectorAll('.show-map').forEach(button => {
            button.addEventListener('click', () => {
              const lat = parseFloat(button.getAttribute('data-lat'));
              const lng = parseFloat(button.getAttribute('data-lng'));
              const address = button.getAttribute('data-address');
              const customerName = button.getAttribute('data-customer');
              showMap(lat, lng, address, customerName);
            });
          });

          document.querySelectorAll('.manage-photos').forEach(button => {
            button.addEventListener('click', async () => {
              currentRequestId = button.getAttribute('data-id');
              const requestDoc = await getDoc(doc(db, 'serviceRequests', currentRequestId));
              const requestData = requestDoc.exists() ? requestDoc.data() : {};

              const beforeWorkPhotosGallery = document.getElementById('beforeWorkPhotosGallery');
              const afterWorkPhotosGallery = document.getElementById('afterWorkPhotosGallery');
              beforeWorkPhotosGallery.innerHTML = '';
              afterWorkPhotosGallery.innerHTML = '';

              if (requestData.beforeWorkPhotos && requestData.beforeWorkPhotos.length > 0) {
                requestData.beforeWorkPhotos.forEach((url, index) => {
                  const container = document.createElement('div');
                  container.className = 'photo-container';
                  container.innerHTML = `
                    <img src="${url}" alt="작업 전 사진">
                    <button class="delete-photo-btn" data-type="before" data-index="${index}">X</button>
                  `;
                  beforeWorkPhotosGallery.appendChild(container);
                });
              }

              if (requestData.afterWorkPhotos && requestData.afterWorkPhotos.length > 0) {
                requestData.afterWorkPhotos.forEach((url, index) => {
                  const container = document.createElement('div');
                  container.className = 'photo-container';
                  container.innerHTML = `
                    <img src="${url}" alt="작업 후 사진">
                    <button class="delete-photo-btn" data-type="after" data-index="${index}">X</button>
                  `;
                  afterWorkPhotosGallery.appendChild(container);
                });
              }

              new bootstrap.Modal(document.getElementById('photoModal')).show();
            });
          });

          document.getElementById('savePhotos').addEventListener('click', async () => {
            const beforeWorkPhotosInput = document.getElementById('beforeWorkPhotos');
            const afterWorkPhotosInput = document.getElementById('afterWorkPhotos');
            const storage = getStorage();

            const uploadPhotos = async (files, type) => {
              const uploadPromises = [];
              for (const file of files) {
                const storageRef = ref(storage, `workPhotos/${currentRequestId}/${type}/${file.name}`);
                const uploadPromise = uploadBytes(storageRef, file).then((snapshot) => {
                  return getDownloadURL(snapshot.ref);
                });
                uploadPromises.push(uploadPromise);
              }
              return Promise.all(uploadPromises);
            };

            try {
              const beforeWorkUrls = beforeWorkPhotosInput.files.length > 0 ? await uploadPhotos(beforeWorkPhotosInput.files, 'before') : [];
              const afterWorkUrls = afterWorkPhotosInput.files.length > 0 ? await uploadPhotos(afterWorkPhotosInput.files, 'after') : [];

              const requestDoc = await getDoc(doc(db, 'serviceRequests', currentRequestId));
              const requestData = requestDoc.exists() ? requestDoc.data() : {};
              const updatedBeforeWorkPhotos = [...(requestData.beforeWorkPhotos || []), ...beforeWorkUrls];
              const updatedAfterWorkPhotos = [...(requestData.afterWorkPhotos || []), ...afterWorkUrls];

              await updateDoc(doc(db, 'serviceRequests', currentRequestId), {
                beforeWorkPhotos: updatedBeforeWorkPhotos,
                afterWorkPhotos: updatedAfterWorkPhotos
              });

              document.getElementById('feedback-message').textContent = '사진이 저장되었습니다.';
              document.getElementById('feedback-message').classList.add('success');
              setTimeout(() => document.getElementById('feedback-message').classList.remove('success'), 2000);
              bootstrap.Modal.getInstance(document.getElementById('photoModal')).hide();
            } catch (error) {
              console.error('사진 저장 오류:', error);
              document.getElementById('feedback-message').textContent = '사진 저장 실패: ' + error.message;
              document.getElementById('feedback-message').classList.add('error');
              setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
            }
          });

          document.querySelectorAll('.delete-photo-btn').forEach(button => {
            button.addEventListener('click', async () => {
              const type = button.getAttribute('data-type');
              const index = parseInt(button.getAttribute('data-index'));
              const requestDoc = await getDoc(doc(db, 'serviceRequests', currentRequestId));
              const requestData = requestDoc.exists() ? requestDoc.data() : {};
              const photos = type === 'before' ? requestData.beforeWorkPhotos : requestData.afterWorkPhotos;
              const urlToDelete = photos[index];

              try {
                const storage = getStorage();
                const storageRef = ref(storage, urlToDelete);
                await deleteObject(storageRef);
                photos.splice(index, 1);
                await updateDoc(doc(db, 'serviceRequests', currentRequestId), {
                  [type === 'before' ? 'beforeWorkPhotos' : 'afterWorkPhotos']: photos
                });
                button.parentElement.remove();
              } catch (error) {
                console.error('사진 삭제 오류:', error);
                document.getElementById('feedback-message').textContent = '사진 삭제 실패: ' + error.message;
                document.getElementById('feedback-message').classList.add('error');
                setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
              }
            });
          });

          document.querySelectorAll('.submit-final-cost').forEach(button => {
            button.addEventListener('click', () => {
              currentRequestId = button.getAttribute('data-id');
              new bootstrap.Modal(document.getElementById('finalCostModal')).show();
            });
          });

          document.getElementById('submitFinalCost').addEventListener('click', async () => {
            const finalCost = parseInt(document.getElementById('finalCostInput').value);
            if (!finalCost || finalCost <= 0) {
              document.getElementById('feedback-message').textContent = '유효한 견적 금액을 입력하세요.';
              document.getElementById('feedback-message').classList.add('error');
              setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
              return;
            }

            try {
              await updateDoc(doc(db, 'serviceRequests', currentRequestId), {
                finalCost: finalCost,
                finalCostStatus: 'pending'
              });
              document.getElementById('feedback-message').textContent = '최종 견적이 제출되었습니다.';
              document.getElementById('feedback-message').classList.add('success');
              setTimeout(() => document.getElementById('feedback-message').classList.remove('success'), 2000);
              bootstrap.Modal.getInstance(document.getElementById('finalCostModal')).hide();
            } catch (error) {
              console.error('견적 제출 오류:', error);
              document.getElementById('feedback-message').textContent = '견적 제출 실패: ' + error.message;
              document.getElementById('feedback-message').classList.add('error');
              setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
            }
          });

          document.querySelectorAll('.send-message').forEach(button => {
            button.addEventListener('click', () => {
              currentRequestId = button.getAttribute('data-id');
              const customerId = button.getAttribute('data-customer-id');
              document.getElementById('messageModal').setAttribute('data-customer-id', customerId);
              new bootstrap.Modal(document.getElementById('messageModal')).show();
            });
          });

          document.getElementById('sendMessage').addEventListener('click', async () => {
            const message = document.getElementById('messageInput').value;
            const customerId = document.getElementById('messageModal').getAttribute('data-customer-id');
            if (!message) {
              document.getElementById('feedback-message').textContent = '메시지를 입력하세요.';
              document.getElementById('feedback-message').classList.add('error');
              setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
              return;
            }

            try {
              await addDoc(collection(db, 'messages'), {
                requestId: currentRequestId,
                senderId: workerId,
                receiverId: customerId,
                message: message,
                createdAt: serverTimestamp()
              });
              document.getElementById('feedback-message').textContent = '메시지가 전송되었습니다.';
              document.getElementById('feedback-message').classList.add('success');
              setTimeout(() => document.getElementById('feedback-message').classList.remove('success'), 2000);
              bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
            } catch (error) {
              console.error('메시지 전송 오류:', error);
              document.getElementById('feedback-message').textContent = '메시지 전송 실패: ' + error.message;
              document.getElementById('feedback-message').classList.add('error');
              setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
            }
          });
        }, (error) => {
          console.error('실시간 데이터 조회 오류:', error);
          document.getElementById('feedback-message').textContent = '데이터 조회 실패: ' + error.message;
          document.getElementById('feedback-message').classList.add('error');
          setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
          // 재시도 로직 추가
          setTimeout(() => loadWorkerRequests(workerRegions, workerId), 5000); // 5초 후 재시도
        });
      }

      function loadWorkerLogs(workerId) {
        const logsTable = document.getElementById('work-logs-table');
        logsTable.innerHTML = '';
        const q = query(collection(db, 'workLogs'), where('workerId', '==', workerId), orderBy('updatedAt', 'desc'));
        onSnapshot(q, (snapshot) => {
          logsTable.innerHTML = '';
          snapshot.forEach((doc) => {
            const log = doc.data();
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${log.requestId}</td>
              <td>${log.requestDetails?.serviceType || '-'}</td>
              <td>${log.requestDetails?.customerName || '-'}</td>
              <td>${log.status || 'pending'}</td>
              <td>${log.startTime ? new Date(log.startTime.toDate()).toLocaleString('ko-KR') : '-'}</td>
              <td>${log.endTime ? new Date(log.endTime.toDate()).toLocaleString('ko-KR') : '-'}</td>
              <td>${log.updatedAt ? new Date(log.updatedAt.toDate()).toLocaleString('ko-KR') : '-'}</td>
              <td>${log.notes || '-'}</td>
              <td><button class="btn btn-primary btn-sm update-log" data-id="${doc.id}">메모 추가</button></td>
            `;
            logsTable.appendChild(row);
          });

          document.querySelectorAll('.update-log').forEach(button => {
            button.addEventListener('click', async () => {
              const id = button.getAttribute('data-id');
              const newNotes = prompt('작업 메모를 입력하세요:');
              if (newNotes) {
                try {
                  await updateDoc(doc(db, 'workLogs', id), {
                    notes: newNotes,
                    updatedAt: serverTimestamp()
                  });
                  document.getElementById('feedback-message').textContent = '작업 로그가 업데이트되었습니다.';
                  document.getElementById('feedback-message').classList.add('success');
                  setTimeout(() => document.getElementById('feedback-message').classList.remove('success'), 2000);
                } catch (error) {
                  console.error('로그 업데이트 오류:', error);
                  document.getElementById('feedback-message').textContent = '로그 업데이트 실패: ' + error.message;
                  document.getElementById('feedback-message').classList.add('error');
                  setTimeout(() => document.getElementById('feedback-message').classList.remove('error'), 2000);
                }
              }
            });
          });
        }, (error) => {
          console.error('작업 로그 조회 오류:', error);
          logsTable.innerHTML = '<tr><td colspan="9">작업 로그를 불러올 수 없습니다.</td></tr>';
          // 재시도 로직 추가
          setTimeout(() => loadWorkerLogs(workerId), 5000); // 5초 후 재시도
        });
      }

      function showMap(lat, lng, address, customerName) {
        const mapModal = document.getElementById('mapModal');
        mapModal.addEventListener('shown.bs.modal', () => {
          currentMap.relayout();
        });
        const mapElement = document.getElementById('map');
        const mapOptions = {
          center: new kakao.maps.LatLng(lat, lng),
          level: 3,
          mapTypeId: kakao.maps.MapTypeId.HYBRID
        };
        kakao.maps.load(() => {
          currentMap = new kakao.maps.Map(mapElement, mapOptions);
          new bootstrap.Modal(document.getElementById('mapModal')).show();
          const markerPosition = new kakao.maps.LatLng(lat, lng);
          const marker = new kakao.maps.Marker({
            position: markerPosition,
            title: address
          });
          marker.setMap(currentMap);

          const infowindow = new kakao.maps.InfoWindow({
            content: `<div style="padding:5px;">고객: ${customerName}<br>주소: ${address}</div>`
          });
          infowindow.open(currentMap, marker);
        });
      }
    });
  </script>
</body>
</html>