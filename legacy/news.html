<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>벌초/예초 정보 - 원스톱 벌초</title>
    <meta name="description" content="전국 각 지역별 벌초, 예초, 태양광 관리 관련 최신 정보와 전문가 팁을 확인하세요. 서울 강남구, 부산 해운대구, 인천 연수구 등 전국 시/군/구별 벌초/예초 현황과 트렌드를 한눈에 보실 수 있습니다.">
    <meta name="keywords" content="벌초, 예초, 벌초대행, 지역별 벌초, 예초기, 태양광 예초, 묘지관리, 산소관리, 서울 강남구 벌초, 부산 해운대구 예초, 인천 연수구 벌초대행, 경기 수원시 벌초, 대구 수성구 예초, 광주 광산구 벌초대행">
    
    <!-- Open Graph 태그 -->
    <meta property="og:title" content="벌초/예초 정보 | 원스톱 벌초">
    <meta property="og:description" content="전국 각 지역별 벌초, 예초, 태양광 관리 관련 최신 정보와 전문가 팁을 확인하세요. 서울 강남구, 부산 해운대구, 인천 연수구 등 전국 시/군/구별 벌초/예초 현황과 트렌드를 한눈에 보실 수 있습니다.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://your-domain.com/news.html">
    <meta property="og:image" content="assets/images/og-image.jpg">
    
    <!-- 구조화된 데이터 -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "벌초/예초 정보",
        "description": "전국 각 지역별 벌초, 예초, 태양광 관리 관련 최신 정보와 전문가 팁을 확인하세요.",
        "url": "https://your-domain.com/news.html",
        "publisher": {
            "@type": "Organization",
            "name": "원스톱 벌초",
            "logo": {
                "@type": "ImageObject",
                "url": "https://your-domain.com/assets/images/logo.png"
            }
        },
        "mainEntity": {
            "@type": "ItemList",
            "itemListElement": [
                {
                    "@type": "ListItem",
                    "position": 1,
                    "name": "벌초/예초 트렌드",
                    "description": "최신 벌초/예초 트렌드와 시장 동향"
                },
                {
                    "@type": "ListItem",
                    "position": 2,
                    "name": "전문가 팁",
                    "description": "효율적인 벌초/예초 방법과 전문가 조언"
                },
                {
                    "@type": "ListItem",
                    "position": 3,
                    "name": "지역별 정보",
                    "description": "전국 시/군/구별 벌초/예초 현황"
                }
            ]
        }
    }
    </script>

    <!-- 기존 스타일시트 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="components/footer.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.5.0/firebase-storage-compat.js"></script>

    <!-- Firebase Config -->
    <script src="scripts/firebase-config.js"></script>

    <!-- Navigation -->
    <script type="module" src="scripts/navbar.js"></script>
    
    <!-- Footer -->
    <script src="components/footer.js"></script>

    <style>
        .news-container {
            margin-top: 80px;
            margin-bottom: 40px;
            padding: 40px 0;
        }
        .news-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .news-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .news-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .news-date {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        .news-content {
            color: #333;
            line-height: 1.6;
        }
        .news-category {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-bottom: 10px;
        }
        .category-trend {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .category-tip {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        .category-news {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .error-message {
            color: #dc3545;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #dc3545;
            border-radius: 4px;
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <!-- 네비게이션 -->
    <div id="navbar-placeholder"></div>

    <main class="container news-container">
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <h1 class="mb-4">벌초/예초 정보</h1>
                <div id="news-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i> 뉴스를 불러오는 중...
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 푸터 -->
    <div id="footer-placeholder"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- News Script -->
    <script>
        // API 키 설정
        const GEMINI_API_KEY = 'AIzaSyBBHv-isFTKlAr0XMkuNp-Lzd2an-QDb_0';
        
        // Firebase 초기화 확인
        let db;
        try {
            db = firebase.firestore();
            console.log('Firebase Firestore 초기화 완료');
        } catch (error) {
            console.error('Firebase Firestore 초기화 실패:', error);
        }
        
        // 뉴스 생성 함수
        async function generateNews(region, category) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `
                                ${region}의 ${category}에 대한 뉴스 기사를 작성해주세요.
                                다음 형식으로 작성해주세요:
                                1. 제목 (첫 줄)
                                2. 본문 (2줄 이상)
                                `
                            }]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API 호출 실패: ${errorData.error?.message || '알 수 없는 오류'}`);
                }

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error('뉴스 생성 중 오류:', error);
                throw error;
            }
        }

        // 뉴스를 Firebase에 저장
        async function saveNewsToFirebase(news) {
            try {
                if (!db) {
                    throw new Error('Firebase Firestore가 초기화되지 않았습니다.');
                }
                const newsRef = db.collection('news');
                await newsRef.add({
                    ...news,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('뉴스 저장 완료:', news.title);
            } catch (error) {
                console.error('뉴스 저장 중 오류:', error);
                throw error;
            }
        }

        // 지역별 뉴스 필터링
        function filterNewsByRegion(newsItems, selectedRegion) {
            if (!selectedRegion) return newsItems;
            return newsItems.filter(news => news.region === selectedRegion);
        }

        // 뉴스 목록 표시 함수
        async function displayNews(selectedRegion = null) {
            const newsList = document.getElementById('news-list');
            newsList.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> 뉴스를 불러오는 중...</div>';

            try {
                if (!db) {
                    throw new Error('Firebase Firestore가 초기화되지 않았습니다.');
                }

                // 지역 및 카테고리 목록
                const regions = ['서울 강남구', '부산 해운대구', '인천 연수구', '경기 수원시', '대구 수성구'];
                const categories = ['벌초 서비스', '예초 서비스', '태양광 관리'];

                // Firebase에서 기존 뉴스 가져오기
                const newsSnapshot = await db.collection('news').get();
                const existingNews = newsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // 새로운 뉴스 생성
                const newsPromises = regions.flatMap(region => 
                    categories.map(async category => {
                        // 이미 해당 지역과 카테고리의 뉴스가 있는지 확인
                        const existingNewsForRegion = existingNews.find(
                            news => news.region === region && news.category === category
                        );

                        if (existingNewsForRegion) {
                            return existingNewsForRegion;
                        }

                        const content = await generateNews(region, category);
                        const [title, ...body] = content.split('\n');
                        const news = {
                            title: title.trim(),
                            content: body.join('\n').trim(),
                            region,
                            category,
                            date: new Date().toLocaleDateString('ko-KR')
                        };

                        // Firebase에 저장
                        await saveNewsToFirebase(news);
                        return news;
                    })
                );

                const newsItems = await Promise.all(newsPromises);
                const filteredNews = filterNewsByRegion(newsItems, selectedRegion);
                
                // 지역 선택 UI 추가
                const regionSelector = `
                    <div class="mb-4">
                        <select class="form-select" onchange="displayNews(this.value)">
                            <option value="">전체 지역</option>
                            ${regions.map(region => `
                                <option value="${region}" ${selectedRegion === region ? 'selected' : ''}>
                                    ${region}
                                </option>
                            `).join('')}
                        </select>
                    </div>
                `;

                // 뉴스 카드 생성
                newsList.innerHTML = regionSelector + filteredNews.map(news => `
                    <div class="news-card">
                        <span class="news-category category-${news.category.includes('벌초') ? 'trend' : 'news'}">
                            ${news.region} ${news.category}
                        </span>
                        <h2 class="news-title">${news.title}</h2>
                        <div class="news-date">${news.date}</div>
                        <div class="news-content">${news.content}</div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('뉴스 표시 중 오류:', error);
                newsList.innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-circle"></i> 뉴스를 불러오는 중 오류가 발생했습니다.
                        <br>${error.message}
                    </div>
                `;
            }
        }

        // 페이지 로드 시 뉴스 표시
        window.addEventListener('DOMContentLoaded', displayNews);
    </script>
</body>
</html>