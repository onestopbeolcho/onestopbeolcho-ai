<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="비회원 재신청 및 조회 - 이전 신청 정보를 확인하고 재신청하세요.">
  <meta name="robots" content="index, follow">
  <title>비회원 재신청 및 조회 - 원스톱 벌초 서비스</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="/styles/common.css">
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=ef6b942fdad36e982c84eb0061d1d2ed&libraries=services"></script>
</head>
<body class="dark-mode">
  <nav id="nav-container"></nav>
  <div class="container">
    <h2 class="text-center mb-4 fw-bold">비회원 재신청 및 조회</h2>
    <div class="card p-4">
      <p class="text-center mb-4" style="color: #333333;">
        이전에 신청하셨던 정보를 입력하여 재신청하거나 신청 내역을 조회하세요.
      </p>
      <form id="re-request-form">
        <div class="mb-3">
          <label for="re-request-name" class="form-label">이름</label>
          <input type="text" id="re-request-name" class="form-control" placeholder="이름 입력" required>
        </div>
        <div class="mb-3">
          <label for="re-request-phone" class="form-label">연락처</label>
          <input type="tel" id="re-request-phone" class="form-control" placeholder="01012345678" required>
        </div>
        <div class="mb-4">
          <label for="re-request-password" class="form-label">비밀번호</label>
          <input type="password" id="re-request-password" class="form-control" placeholder="비밀번호 입력" required>
        </div>
        <div class="btn-group">
          <button type="button" id="check-request-btn" class="btn btn-outline-primary">신청 조회</button>
          <button type="submit" class="btn btn-primary">재신청하기</button>
        </div>
      </form>
      <div id="request-details" class="mt-4" style="display: none;"></div>
    </div>
  </div>
  <footer class="text-center py-3 shadow-sm" id="footer-container"></footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script src="/scripts/nav.js" type="module" defer></script>
  <script src="/scripts/footer.js" type="module" defer></script>
  <script src="/scripts/common.js" defer></script>
  <script type="module">
    import { db, collection, query, where, getDocs, Timestamp, addDoc } from '/scripts/firebase-config.js';

    document.addEventListener('DOMContentLoaded', () => {
      const reRequestForm = document.getElementById('re-request-form');
      const checkRequestBtn = document.getElementById('check-request-btn');
      const requestDetails = document.getElementById('request-details');
      const nameInput = document.getElementById('re-request-name');
      const phoneInput = document.getElementById('re-request-phone');
      const passwordInput = document.getElementById('re-request-password');

      if (!reRequestForm || !checkRequestBtn || !requestDetails || !nameInput || !phoneInput || !passwordInput) {
        console.error('필수 DOM 요소를 찾을 수 없습니다.');
        return;
      }

      // 상태를 한국어로 매핑
      const statusMap = {
        'pending': '대기 중',
        'in-progress': '진행 중',
        'completed': '완료',
        'cancelled': '취소'
      };

      // 지도 초기화 함수
      function initializeMap(containerId, lat, lng) {
        const mapOptions = {
          center: new kakao.maps.LatLng(lat, lng),
          level: 3,
          mapTypeId: kakao.maps.MapTypeId.HYBRID
        };
        const map = new kakao.maps.Map(document.getElementById(containerId), mapOptions);
        const marker = new kakao.maps.Marker({
          position: new kakao.maps.LatLng(lat, lng),
          draggable: true
        });
        marker.setMap(map);
        return { map, marker };
      }

      // 수정된 위치 저장용 변수
      let modifiedLat = null;
      let modifiedLng = null;

      checkRequestBtn.addEventListener('click', async () => {
        checkRequestBtn.disabled = true;
        checkRequestBtn.textContent = '조회 중...';
        const name = nameInput.value;
        const phone = phoneInput.value;
        const password = passwordInput.value;

        if (!name || !phone || !password) {
          alert('모든 필드를 입력해주세요.');
          checkRequestBtn.disabled = false;
          checkRequestBtn.textContent = '신청 조회';
          return;
        }

        const phoneRegex = /^010\d{8}$/;
        if (!phoneRegex.test(phone)) {
          alert('연락처는 010으로 시작하는 11자리 숫자여야 합니다. (예: 01012345678)');
          checkRequestBtn.disabled = false;
          checkRequestBtn.textContent = '신청 조회';
          return;
        }

        try {
          console.log('입력값:', { name, phone, password });
          const previousRequestQuery = query(
            collection(db, 'serviceRequests'),
            where('customerName', '==', name),
            where('customerPhone', '==', phone),
            where('customerPassword', '==', password)
          );
          const previousRequestSnapshot = await getDocs(previousRequestQuery);
          console.log('조회된 문서 수:', previousRequestSnapshot.size);
          console.log('조회된 문서 데이터:', previousRequestSnapshot.docs.map(doc => doc.data()));

          if (previousRequestSnapshot.empty) {
            throw new Error('신청 내역을 찾을 수 없습니다. 입력 정보를 확인해주세요.');
          }

          requestDetails.style.display = 'block';
          requestDetails.innerHTML = '<h5 class="mt-3 fw-bold">이전 신청 내역</h5>';
          previousRequestSnapshot.forEach(doc => {
            const request = doc.data();
            const formattedCreatedAt = request.createdAt ? new Date(request.createdAt.seconds * 1000).toLocaleDateString() : '정보 없음';
            const mapId = `map-${doc.id}`; // 각 신청 내역에 고유한 지도 ID 생성
            requestDetails.innerHTML += `
              <div class="card p-3 mb-2">
                <p class="mb-1">신청일: ${formattedCreatedAt}</p>
                <p class="mb-1">서비스: ${request.serviceType || '정보 없음'}</p>
                <p class="mb-1">지역: ${request.region || '정보 없음'}</p>
                <p class="mb-1">주소: ${request.address || '정보 없음'}</p>
                <p class="mb-1">작업 날짜: ${request.workDate || '정보 없음'}</p>
                <p class="mb-1">상태: ${statusMap[request.status] || '정보 없음'}</p>
                <div id="${mapId}" style="width: 100%; height: 300px; margin-top: 10px;"></div>
              </div>
            `;

            // 지도 초기화
            if (request.latitude && request.longitude) {
              const { map, marker } = initializeMap(mapId, request.latitude, request.longitude);
              // 마커 드래그 이벤트 리스너 추가
              kakao.maps.event.addListener(marker, 'dragend', () => {
                const position = marker.getPosition();
                modifiedLat = position.getLat();
                modifiedLng = position.getLng();
                console.log('수정된 위치:', { lat: modifiedLat, lng: modifiedLng });
              });
            }
          });
        } catch (error) {
          console.error('신청 조회 실패:', error);
          alert('신청 조회에 실패했습니다: ' + error.message);
        } finally {
          checkRequestBtn.disabled = false;
          checkRequestBtn.textContent = '신청 조회';
        }
      });

      reRequestForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const name = nameInput.value;
        const phone = phoneInput.value;
        const password = passwordInput.value;

        if (!name || !phone || !password) {
          alert('모든 필드를 입력해주세요.');
          return;
        }

        const phoneRegex = /^010\d{8}$/;
        if (!phoneRegex.test(phone)) {
          alert('연락처는 010으로 시작하는 11자리 숫자여야 합니다. (예: 01012345678)');
          return;
        }

        try {
          const previousRequestQuery = query(
            collection(db, 'serviceRequests'),
            where('customerName', '==', name),
            where('customerPhone', '==', phone),
            where('customerPassword', '==', password)
          );
          const previousRequestSnapshot = await getDocs(previousRequestQuery);

          if (previousRequestSnapshot.empty) {
            throw new Error('이전에 신청한 정보를 찾을 수 없습니다. 입력 정보를 확인해주세요.');
          }

          const previousRequest = previousRequestSnapshot.docs[0].data();
          const reRequestData = {
            customerName: name,
            customerPhone: phone,
            customerPassword: password,
            createdAt: Timestamp.fromDate(new Date()),
            status: 'pending',
            previousRequest: {
              serviceType: previousRequest.serviceType || '정보 없음',
              region: previousRequest.region || '정보 없음',
              address: previousRequest.address || '정보 없음',
              createdAt: previousRequest.createdAt || null,
              estimatedCost: previousRequest.estimatedCost?.totalCost || previousRequest.estimatedCost || null,
              latitude: modifiedLat || previousRequest.latitude || null, // 수정된 위치 반영
              longitude: modifiedLng || previousRequest.longitude || null, // 수정된 위치 반영
              workDate: previousRequest.workDate || '정보 없음',
              workerRequest: previousRequest.workerRequest || '정보 없음',
              ...(previousRequest.details || {})
            }
          };

          await addDoc(collection(db, 're-requests'), reRequestData);
          alert(`재신청이 완료되었습니다!`);
          requestDetails.innerHTML += `
            <h5 class="mt-3 fw-bold">재신청 내역</h5>
            <div class="card p-3 mb-2">
              <p class="mb-1">재신청일: ${new Date(reRequestData.createdAt.seconds * 1000).toLocaleDateString()}</p>
              <p class="mb-1">상태: ${statusMap[reRequestData.status] || '정보 없음'}</p>
            </div>
          `;
        } catch (error) {
          console.error('재신청 저장 실패:', error);
          alert('재신청에 실패했습니다: ' + error.message);
        }
      });
    });
  </script>
</body>
</html>