<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="원스톱 벌초 - 회원가입">
    <meta name="keywords" content="회원가입, 원스톱 벌초, 사용자 인증">
    <title>회원가입 | 원스톱 벌초</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E88E5">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">
    <link rel="stylesheet" href="styles/common.css">
    <link rel="stylesheet" href="components/footer.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background-color: #f5f5f5;
            font-family: 'Inter', sans-serif;
            display: flex; 
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
        }
        .signup-container {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }
        .signup-container h2 {
            text-align: center;
            color: #1E88E5;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            display: block;
        }
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }
        .form-group input:focus {
            border-color: #1E88E5;
            outline: none;
            box-shadow: 0 0 5px rgba(30, 136, 229, 0.3);
        }
        .btn-signup {
            width: 100%;
            padding: 12px;
            background-color: #1E88E5;
            border: none;
            color: #fff;
            font-size: 1.1em;
            border-radius: 5px;
            cursor: pointer;
        }
        .feedback-message {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .feedback-message.error {
            background: #ffebee;
            color: #c62828;
            display: block;
        }
        .feedback-message.success {
            background: #e3f2fd;
            color: #1E88E5;
            display: block;
        }
        .login-link {
            text-align: center;
            margin-top: 15px;
        }
        .login-link a {
            color: #1E88E5;
            text-decoration: none;
        }
        .login-link a:hover {
            text-decoration: underline;
        }
        #footer-container {
            background: #333;
            color: #fff;
            text-align: center;
            padding: 10px 0;
            position: relative;
            bottom: 0;
            width: 100%;
            display: block !important;
        }
        #footer-container .container {
            margin: 0 auto;
        }
        #footer-container a {
            color: #1E88E5;
            text-decoration: none;
        }
        #footer-container a:hover {
            text-decoration: underline;
        }
        @media (max-width: 991px) {
            .navbar-collapse {
                background: #343a40;
                padding: 10px;
            }
            .navbar-nav {
                width: 100%;
                text-align: center;
            }
            .nav-item {
                padding: 5px 0;
            }
        }
        @media (max-width: 480px) {
            .signup-container {
                padding: 20px;
                margin: 10px;
            }
            .form-group input {
                font-size: 0.9em;
            }
            .btn-signup {
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <!-- 네비게이션 -->
    <div id="navbar-placeholder"></div>

    <main class="container py-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <h1 class="text-center mb-4">회원가입</h1>
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">회원가입</h5>
                        <p class="card-text">회원가입을 진행하세요.</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">이용약관</h5>
                        <p class="card-text">이용약관을 확인하세요.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 푸터 -->
    <div id="footer-container"></div>

    <!-- 스크립트 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="scripts/firebase-config.js"></script>
    <script type="module" src="scripts/auth.js"></script>
    <script src="scripts/navbar.js"></script>
    <script src="components/footer.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';

        const firebaseConfig = {
          apiKey: "AIzaSyBWADxFFsfyJGRqI09AJx1pDQhrWv_pQzo",
          authDomain: "onestop-88b05.firebaseapp.com",
          projectId: "onestop-88b05",
          storageBucket: "onestop-88b05.firebasestorage.app",
          messagingSenderId: "189609926021",
          appId: "1:189609926021:web:19a330a166ff2ba58378ec",
          measurementId: "G-FKZLEVZ8M8"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/service-worker.js')
                .then((registration) => {
                    registration.update();
                    console.log('Service Worker 등록 성공');
                })
                .catch((error) => console.error('Service Worker 등록 실패:', error));
        }

        document.addEventListener('DOMContentLoaded', () => {
            const phoneInput = document.getElementById('phone');
            
            // 전화번호 자동 하이픈 입력
            phoneInput.addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 3 && value.length <= 7) {
                    value = value.slice(0, 3) + '-' + value.slice(3);
                } else if (value.length > 7) {
                    value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
                }
                e.target.value = value;
            });

            const signupForm = document.getElementById('signup-form');
            const feedbackMessage = document.getElementById('feedback-message');

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('name').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value.trim();
                const confirmPassword = document.getElementById('confirm-password').value.trim();

                // 입력값 검증
                if (!name || !phone || !email || !password || !confirmPassword) {
                    feedbackMessage.textContent = '모든 필드를 입력해주세요.';
                    feedbackMessage.classList.remove('success');
                    feedbackMessage.classList.add('error');
                    return;
                }

                if (password !== confirmPassword) {
                    feedbackMessage.textContent = '비밀번호가 일치하지 않습니다.';
                    feedbackMessage.classList.remove('success');
                    feedbackMessage.classList.add('error');
                    return;
                }

                if (password.length < 6) {
                    feedbackMessage.textContent = '비밀번호는 6자 이상이어야 합니다.';
                    feedbackMessage.classList.remove('success');
                    feedbackMessage.classList.add('error');
                    return;
                }

                const phoneRegex = /^010-\d{4}-\d{4}$/;
                if (!phoneRegex.test(phone)) {
                    feedbackMessage.textContent = '전화번호 형식이 올바르지 않습니다.';
                    feedbackMessage.classList.remove('success');
                    feedbackMessage.classList.add('error');
                    return;
                }

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    feedbackMessage.textContent = '이메일 형식이 올바르지 않습니다.';
                    feedbackMessage.classList.remove('success');
                    feedbackMessage.classList.add('error');
                    return;
                }

                try {
                    console.log('회원가입 시도:', { email, name, phone });
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    console.log('Firebase 인증 성공:', user.uid);

                    // Firestore에 사용자 정보 저장
                    await setDoc(doc(db, 'users', user.uid), {
                        name: name,
                        phone: phone,
                        email: email,
                        createdAt: serverTimestamp(),
                        role: 'user',
                        isAdmin: false,
                        isWorker: false
                    });
                    console.log('Firestore 저장 성공');

                    feedbackMessage.textContent = '회원가입이 완료되었습니다!';
                    feedbackMessage.classList.remove('error');
                    feedbackMessage.classList.add('success');
                    
                    // 2초 후 로그인 페이지로 이동
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);

                } catch (error) {
                    console.error('회원가입 오류:', error);
                    let errorMessage = '회원가입 중 오류가 발생했습니다.';
                    
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = '이미 사용 중인 이메일입니다.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = '잘못된 이메일 형식입니다.';
                            break;
                        case 'auth/operation-not-allowed':
                            errorMessage = '이메일/비밀번호 계정이 비활성화되어 있습니다.';
                            break;
                        case 'auth/weak-password':
                            errorMessage = '비밀번호가 너무 약합니다.';
                            break;
                    }
                    
                    feedbackMessage.textContent = errorMessage;
                    feedbackMessage.classList.remove('success');
                    feedbackMessage.classList.add('error');
                }
            });
        });
    </script>
    </main>
</body>
</html>